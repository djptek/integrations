config_version: 2
interval: {{interval}}
auth.oauth2:
  client.id: {{client_id}}
  client.secret: {{client_secret}}
  token_url: {{api_url}}/oauth2/token
  endpoint_params:
    box_subject_id: {{box_subject_id}}
    box_subject_type: {{box_subject_type}}
    grant_type: {{grant_type}}
request.url: {{api_url}}/2.0/events
request.method: "POST"
request.transforms:
  - set:
    target: url.params.stream_position
    value: '[[.cursor.next_stream_position]]'
response.decode_as: application/json
response.split:
  target: body.entries
  type: array
response.pagination:
- set:
    target: body.meta.pagination.pageToken
    value: '[[.last_response.body.meta.pagination.next]]'
    fail_on_template_error: true
cursor:
  next_stream_position:
    value: '[[.last_response.body.next_stream_position]]'
tags:
{{#if preserve_original_event}}
- preserve_original_event
{{/if}}
{{#each tags as |tag i|}}
- {{tag}}
{{/each}}
processors:
  - decode_json_fields:
      fields: message
      target: box
      add_error_key: true
  - timestamp:
      field: box.created_at
      layouts:
        - '2006-01-02T15:04:05-07:00'
      test:
        - '2006-01-02T15:04:05-07:00'
  - rename:
      when: 
        not:
          equals:
            box.source.type: "folder"
      fields:
        - from: box.source.name
          to: file.name
      ignore_missing: true
      fail_on_error: false      
  - rename:
      when: 
        equals:
          box.source.type: "folder"
      fields:
        - from: box.source.name
          to: file.directory
      ignore_missing: true
      fail_on_error: false      
  - rename:
      fields:
        - from: box.created_by.id
          to: client.user.id
        - from: box.created_by.name
          to: client.user.full_name
        - from: box.created_by.login
          to: client.user.email
        - from: box.type
          to: event.kind
        - from: box.created_by.type
          to: event.type
        - from: box.event_type
          to: event.action
        - from: box.source.sequence_id
          to: event.sequence
        - from: box.source.type
          to: file.type
        - from: box.source.created_at
          to: file.created
        - from: box.source.modified_at
          to: file.modified
        - from: box.source.size
          to: file.size
        - from: box.source.file_version.sha1
          to: file.hash.sha1
      ignore_missing: true
      fail_on_error: false      
  - drop_fields:
      fields: ["message","box.created_at"]
      ignore_missing: true
